\NeedsTeXFormat{LaTeX2e}[1994/06/01]
\ProvidesPackage{dottimeline}[2026/02/25 v4.0 Dot Timeline Package with Per-Milestone Height]

% Required packages
\RequirePackage{tikz}
\RequirePackage{xifthen}
\RequirePackage{xparse}
\RequirePackage{kvoptions}
\usetikzlibrary{calendar}

% Setup key-value options
\SetupKeyvalOptions{
	family=dottimeline,
	prefix=dtl@
}

% Define package options
\DeclareStringOption[14]{width}
\DeclareStringOption[1.5]{heightabove}
\DeclareStringOption[1.5]{heightbelow}
\DeclareStringOption[3pt]{dotsize}
\DeclareStringOption[timelineblue]{color}
\DeclareStringOption[timelineorange]{highlightcolor}
\DeclareStringOption[]{startdate}
\DeclareStringOption[]{enddate}
\DeclareStringOption[0]{rotation}
\DeclareStringOption[3cm]{labelwidth}
\DeclareStringOption[\small]{fontsize}

% Define colors
\definecolor{timelineblue}{RGB}{65, 105, 165}
\definecolor{timelineorange}{RGB}{205, 100, 50}
\definecolor{timelinegray}{RGB}{200, 200, 200}

\ProcessKeyvalOptions*

% Counter for automatic positioning
\newcounter{dtl@milestonepos}

% TeX count registers for Julian day calculations
\newcount\dtl@startjulian
\newcount\dtl@endjulian
\newcount\dtl@milestonejulian
\newcount\dtl@tempjulian
\newcount\dtl@totaldays
\newcount\dtl@markerjulian

% Per-milestone height variables
\newcommand{\dtl@milestone@heightabove}{\dtl@heightabove}
\newcommand{\dtl@milestone@heightbelow}{\dtl@heightbelow}

% Timeline environment
\NewDocumentEnvironment{timeline}{O{}}
{%
	% Process local options
	\setkeys{dottimeline}{#1}
	
	% Initialize per-milestone heights to defaults
	\edef\dtl@milestone@heightabove{\dtl@heightabove}
	\edef\dtl@milestone@heightbelow{\dtl@heightbelow}
	
	\begin{tikzpicture}[
		every node/.style={font=\sffamily},
		]
		% Draw main timeline
		\draw[thick,\dtl@color!50] (0,0) -- (\dtl@width,0);
		\setcounter{dtl@milestonepos}{0}
		
		% Initialize total days
		\dtl@totaldays=0
		
		% Calculate date range if provided
		\ifthenelse{\equal{\dtl@startdate}{}}{}{%
			\ifthenelse{\equal{\dtl@enddate}{}}{}{%
				\pgfcalendardatetojulian{\dtl@startdate}{\dtl@startjulian}
				\pgfcalendardatetojulian{\dtl@enddate}{\dtl@endjulian}
				\dtl@totaldays=\dtl@endjulian
				\advance\dtl@totaldays by -\dtl@startjulian
			}%
		}%
	}
	{
	\end{tikzpicture}
}

% Calculate position based on date
\newcommand{\dtl@calculateposition}[2]{%
	% #1 = milestone date
	% #2 = output macro (x position)
	\ifnum\dtl@totaldays>0
	% Date-based positioning
	\pgfcalendardatetojulian{#1}{\dtl@milestonejulian}
	\dtl@tempjulian=\dtl@milestonejulian
	\advance\dtl@tempjulian by -\dtl@startjulian
	% Now use pgfmath with the smaller relative day number
	\pgfmathsetmacro{#2}{(\the\dtl@tempjulian / \the\dtl@totaldays) * \dtl@width}
	% Ensure position is within bounds
	\ifdim#2pt<0pt \def#2{0}\fi
	\ifdim#2pt>\dtl@width pt \edef#2{\dtl@width}\fi
	\else
	% Automatic positioning (fallback)
	\stepcounter{dtl@milestonepos}
	\pgfmathsetmacro{#2}{(\thedtl@milestonepos-1)*(\dtl@width/12)}
	\fi
}

% Internal command to draw milestone above timeline
\newcommand{\dtl@drawmilestoneabove}[3]{%
	% #1 = x position
	% #2 = date
	% #3 = label
	\draw (#1,0.1) -- (#1,-0.1);
	\fill[\dtl@color] (#1,\dtl@milestone@heightabove) circle (\dtl@dotsize);
	\draw (#1,\dtl@milestone@heightabove) -- (#1,0.1);
	\node[anchor=south west,align=left,xshift=5pt,inner sep=1pt,rotate=\dtl@rotation] at (#1,\dtl@milestone@heightabove) 
	{\begin{minipage}{\dtl@labelwidth}\dtl@fontsize\textbf{#3}\\[2pt]#2\end{minipage}};
	% Reset to default for next milestone
	\edef\dtl@milestone@heightabove{\dtl@heightabove}
	\edef\dtl@milestone@heightbelow{\dtl@heightbelow}
}

% Internal command to draw milestone below timeline
\newcommand{\dtl@drawmilestonebelow}[3]{%
	% #1 = x position
	% #2 = date
	% #3 = label
	\draw (#1,0.1) -- (#1,-0.1);
	\fill[\dtl@color] (#1,-\dtl@milestone@heightbelow) circle (\dtl@dotsize);
	\draw (#1,-\dtl@milestone@heightbelow) -- (#1,-0.1);
	\node[anchor=north west,align=left,xshift=5pt,inner sep=1pt,rotate=\dtl@rotation] at (#1,-\dtl@milestone@heightbelow) 
	{\begin{minipage}{\dtl@labelwidth}\dtl@fontsize#3\\[2pt]#2\end{minipage}};
	% Reset to default for next milestone
	\edef\dtl@milestone@heightabove{\dtl@heightabove}
	\edef\dtl@milestone@heightbelow{\dtl@heightbelow}
}

% Internal command to draw highlight milestone above timeline
\newcommand{\dtl@drawhighlightabove}[3]{%
	% #1 = x position
	% #2 = date
	% #3 = label
	\draw (#1,0.1) -- (#1,-0.1);
	\fill[\dtl@highlightcolor] (#1,\dtl@milestone@heightabove) circle (\dtl@dotsize);
	\draw (#1,\dtl@milestone@heightabove) -- (#1,0.1);
	\node[anchor=south west,align=left,xshift=5pt,inner sep=1pt,rotate=\dtl@rotation] at (#1,\dtl@milestone@heightabove) 
	{\begin{minipage}{\dtl@labelwidth}\dtl@fontsize\textbf{#3}\\[2pt]#2\end{minipage}};
	% Reset to default for next milestone
	\edef\dtl@milestone@heightabove{\dtl@heightabove}
	\edef\dtl@milestone@heightbelow{\dtl@heightbelow}
}

% Internal command to draw highlight milestone below timeline
\newcommand{\dtl@drawhighlightbelow}[3]{%
	% #1 = x position
	% #2 = date
	% #3 = label
	\draw (#1,0.1) -- (#1,-0.1);
	\fill[\dtl@highlightcolor] (#1,-\dtl@milestone@heightbelow) circle (\dtl@dotsize);
	\draw (#1,-\dtl@milestone@heightbelow) -- (#1,-0.1);
	\node[anchor=north west,align=left,xshift=5pt,inner sep=1pt,rotate=\dtl@rotation] at (#1,-\dtl@milestone@heightbelow) 
	{\begin{minipage}{\dtl@labelwidth}\dtl@fontsize#3\\[2pt]#2\end{minipage}};
	% Reset to default for next milestone
	\edef\dtl@milestone@heightabove{\dtl@heightabove}
	\edef\dtl@milestone@heightbelow{\dtl@heightbelow}
}

% Key-value setup for per-milestone options
\define@key{dtlmilestone}{heightabove}{\edef\dtl@milestone@heightabove{#1}}
\define@key{dtlmilestone}{heightbelow}{\edef\dtl@milestone@heightbelow{#1}}
\define@key{dtlmilestone}{height}{\edef\dtl@milestone@heightabove{#1}\edef\dtl@milestone@heightbelow{#1}}

% Command to add a milestone with optional height
% Usage: \milestone[position][height=value]{date}{label}
\NewDocumentCommand{\milestone}{O{above}O{}mm}{%
	% Reset to defaults first
	\edef\dtl@milestone@heightabove{\dtl@heightabove}
	\edef\dtl@milestone@heightbelow{\dtl@heightbelow}
	% Apply per-milestone options
	\setkeys{dtlmilestone}{#2}
	
	\dtl@calculateposition{#3}{\dtl@xpos}
	
	\ifthenelse{\equal{#1}{above}}
	{%
		\dtl@drawmilestoneabove{\dtl@xpos}{#3}{#4}%
	}
	{%
		\dtl@drawmilestonebelow{\dtl@xpos}{#3}{#4}%
	}
}

% Command for highlighted milestone with optional height
\NewDocumentCommand{\highlightmilestone}{O{above}O{}mm}{%
	% Reset to defaults first
	\edef\dtl@milestone@heightabove{\dtl@heightabove}
	\edef\dtl@milestone@heightbelow{\dtl@heightbelow}
	% Apply per-milestone options
	\setkeys{dtlmilestone}{#2}
	
	\dtl@calculateposition{#3}{\dtl@xpos}
	
	\ifthenelse{\equal{#1}{above}}
	{%
		\dtl@drawhighlightabove{\dtl@xpos}{#3}{#4}%
	}
	{%
		\dtl@drawhighlightbelow{\dtl@xpos}{#3}{#4}%
	}
}

% Command for manual positioning
\NewDocumentCommand{\milestoneat}{O{above}O{}mmm}{%
	% Reset to defaults first
	\edef\dtl@milestone@heightabove{\dtl@heightabove}
	\edef\dtl@milestone@heightbelow{\dtl@heightbelow}
	% Apply per-milestone options
	\setkeys{dtlmilestone}{#2}
	
	\ifthenelse{\equal{#1}{above}}
	{%
		\dtl@drawmilestoneabove{#3}{#4}{#5}%
	}
	{%
		\dtl@drawmilestonebelow{#3}{#4}{#5}%
	}
}

% Command for title
\NewDocumentCommand{\timelinetitle}{m}{%
	\node[anchor=south,font=\sffamily\Large] at (\dtl@width/2,\dtl@heightabove+1) {#1};
}

% Command to add date markers on timeline
\NewDocumentCommand{\datemarker}{mm}{%
	\ifnum\dtl@totaldays>0
	\pgfcalendardatetojulian{#1}{\dtl@markerjulian}
	\dtl@tempjulian=\dtl@markerjulian
	\advance\dtl@tempjulian by -\dtl@startjulian
	\pgfmathsetmacro{\dtl@markerpos}{(\the\dtl@tempjulian / \the\dtl@totaldays) * \dtl@width}
	\draw (\dtl@markerpos,0.05) -- (\dtl@markerpos,-0.05);
	\node[anchor=north,font=\sffamily\small,text=\dtl@color!70] at (\dtl@markerpos,-0.1) {#2};
	\fi
}

\endinput